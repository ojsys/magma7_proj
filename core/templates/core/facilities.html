{% extends 'base.html' %}
{% block title %}{{ facilities_page.hero_title|default:"Our Facilities" }} • Magma7Fitness{% endblock %}
{% block content %}

<!-- Hero Section -->
<section style="width: 100vw; margin-left: calc(-50vw + 50%); min-height: 70vh; display: flex; align-items: center; justify-content: center; text-align: center; position: relative; overflow: hidden; padding: 120px 20px 80px;
  {% if hero_bg_url %}
    background-image: linear-gradient(to bottom, rgba(0,0,0,0.55), rgba(0,0,0,0.55)), url('{{ hero_bg_url }}');
    background-size: cover; background-position: center; background-repeat: no-repeat;
  {% else %}
    background: linear-gradient(135deg, #0a3d2c 0%, var(--primary-dark) 100%);
  {% endif %}">

  <div style="max-width: 1200px; margin: 0 auto; position: relative; z-index: 1;">
    <div style="margin-bottom: 25px;">
      <span style="display: inline-block; background: rgba(255, 255, 255, 0.15); color: white; padding: 8px 25px; border-radius: 50px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 2px;">
        World-Class Amenities
      </span>
    </div>

    <h1 style="font-size: clamp(2.4rem, 4vw, 4rem); font-weight: 900; color: white; margin: 0 auto 1.5rem auto; text-transform: uppercase; line-height: 1.1; text-shadow: 0 4px 20px rgba(0,0,0,0.4);">
      {{ facilities_page.hero_title|default:"Our World-Class Facilities" }}
    </h1>

    {% if facilities_page.hero_subtitle %}
    <p style="color: rgba(255, 255, 255, 0.95); font-size: clamp(1rem, 1.2vw, 1.3rem); max-width: 900px; margin: 0 auto; line-height: 1.7;">
      {{ facilities_page.hero_subtitle }}
    </p>
    {% endif %}
  </div>
</section>

<!-- Introduction Section -->
{% if facilities_page.intro_content %}
<section class="section" style="padding: 80px 0; background: var(--light-bg);">
  <div class="container" style="text-align: center; max-width: 900px;">
    <h2 style="font-size: 2.8rem; font-weight: 800; color: var(--text-primary); margin-bottom: 25px; text-transform: uppercase;">
      {{ facilities_page.intro_title|default:"Everything You Need" }}
    </h2>
    <p style="color: var(--text-secondary); font-size: 1.2rem; line-height: 1.8;">
      {{ facilities_page.intro_content }}
    </p>
  </div>
</section>
{% endif %}

<!-- Facility Photo Gallery -->
{% if gallery_images %}
<section class="section" style="padding: 80px 0; background: var(--section-bg);">
  <div class="container">
    <div style="text-align: center; margin-bottom: 50px;">
      <h2 style="font-size: 3rem; font-weight: 800; color: var(--text-primary); margin-bottom: 15px; text-transform: uppercase;">Facility Photo Gallery</h2>
      <p style="color: var(--text-secondary); font-size: 1.1rem;">A closer look at our space and equipment</p>
    </div>

    <div class="facility-gallery" id="facilityGallery" data-initial-count="24" data-step="24">
      {% for img in gallery_images %}
        <div class="gallery-item {% if forloop.counter0|divisibleby:5 %}wide{% elif forloop.counter0|divisibleby:7 %}tall{% endif %}"
             data-title="{{ img.title }}" data-description="{{ img.description }}">
          <img src="{{ img.image_url }}" alt="{{ img.title }}" loading="lazy">
          <div class="gallery-overlay">
            <div class="gallery-content">
              <h4>{{ img.title }}</h4>
              {% if img.description %}
                <p>{{ img.description }}</p>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Load More Controls -->
    <div class="row" style="margin-top: 30px;">
      <div class="col s12 center">
        <a id="facilityGalleryLoadMore" class="btn btn-primary waves-effect waves-light" style="min-width: 220px;">Load More</a>
        <a id="facilityGalleryShowLess" class="btn btn-outline waves-effect" style="min-width: 220px; display: none; margin-left: 10px;">Show Less</a>
      </div>
    </div>
  </div>

  <!-- Modal viewer -->
  <div id="facilityGalleryModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:9999; align-items:center; justify-content:center; padding:20px;">
    <div style="max-width:1000px; width:100%; background:#111; border-radius:12px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.6);">
      <div style="position:relative; background:#000;">
        <img id="facilityGalleryModalImg" src="" alt="" style="width:100%; height:auto; display:block; max-height:70vh; object-fit:contain;">
        <button id="facilityGalleryModalClose" aria-label="Close" style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.6); border:none; color:#fff; width:40px; height:40px; border-radius:20px; cursor:pointer; font-size:20px;">×</button>
      </div>
      <div style="padding:16px 20px; color:#fff;">
        <h4 id="facilityGalleryModalTitle" style="margin:0 0 8px 0; font-weight:800;"></h4>
        <p id="facilityGalleryModalDesc" style="margin:0; opacity:0.9;"></p>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const modal = document.getElementById('facilityGalleryModal');
      const modalImg = document.getElementById('facilityGalleryModalImg');
      const modalTitle = document.getElementById('facilityGalleryModalTitle');
      const modalDesc = document.getElementById('facilityGalleryModalDesc');
      const modalClose = document.getElementById('facilityGalleryModalClose');

      function openModal(src, title, desc){
        modalImg.src = src; modalTitle.textContent = title || ''; modalDesc.textContent = desc || '';
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
      function closeModal(){ modal.style.display='none'; document.body.style.overflow=''; modalImg.src=''; }

      document.addEventListener('click', function(e){
        const item = e.target.closest('.gallery-item');
        if (item && item.closest('.facility-gallery')) {
          const img = item.querySelector('img');
          openModal(img.getAttribute('src'), item.dataset.title, item.dataset.description);
        }
      });
      modal.addEventListener('click', function(e){ if (e.target === modal) closeModal(); });
      modalClose.addEventListener('click', closeModal);
      document.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeModal(); });

      // Load More behavior
      const container = document.getElementById('facilityGallery');
      const items = container ? Array.from(container.querySelectorAll('.gallery-item')) : [];
      const initial = parseInt(container?.dataset.initialCount || '24');
      const step = parseInt(container?.dataset.step || '24');
      const btnMore = document.getElementById('facilityGalleryLoadMore');
      const btnLess = document.getElementById('facilityGalleryShowLess');
      let visible = initial;

      function renderVisibility() {
        items.forEach((el, idx) => { el.style.display = (idx < visible) ? '' : 'none'; });
        if (items.length <= initial) {
          if (btnMore) btnMore.style.display = 'none';
          if (btnLess) btnLess.style.display = 'none';
        } else {
          if (btnMore) btnMore.style.display = (visible < items.length) ? '' : 'none';
          if (btnLess) btnLess.style.display = (visible > initial) ? '' : 'none';
        }
      }

      if (items.length) {
        renderVisibility();
        btnMore?.addEventListener('click', function(){
          visible = Math.min(items.length, visible + step);
          renderVisibility();
        });
        btnLess?.addEventListener('click', function(){
          visible = initial;
          window.scrollTo({ top: container.getBoundingClientRect().top + window.scrollY - 120, behavior: 'smooth' });
          renderVisibility();
        });
      }
    })();
  </script>
</section>
{% endif %}

<!-- Featured Facilities -->
{% if featured_facilities %}
<section class="section" style="padding: 80px 0; background: var(--section-bg);">
  <div class="container">
    <div style="text-align: center; margin-bottom: 60px;">
      <h2 style="font-size: 3rem; font-weight: 800; color: var(--text-primary); margin-bottom: 20px; text-transform: uppercase;">Featured Facilities</h2>
      <p style="color: var(--text-secondary); font-size: 1.2rem;">Our most popular amenities</p>
    </div>

    <div class="row" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 30px;">
      {% for facility in featured_facilities %}
      <div class="col s12 m6 l4" style="display: flex;">
        <div class="card hoverable" style="width: 100%; overflow: hidden; transition: all 0.3s ease;">
          {% if facility.image_url %}
          <div style="height: 250px; overflow: hidden; position: relative;">
            <img src="{{ facility.image_url }}" alt="{{ facility.name }}"
                 style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease;"
                 onmouseover="this.style.transform='scale(1.1)'"
                 onmouseout="this.style.transform='scale(1)'">
            <div style="position: absolute; top: 20px; right: 20px; background: var(--primary-green); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 0.85rem;">
              FEATURED
            </div>
          </div>
          {% endif %}
          <div class="card-content" style="padding: 30px;">
            <div style="display: flex; align-items: center; margin-bottom: 20px;">
              <div style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-dark) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 20px;">
                <i class="material-icons" style="font-size: 2rem; color: white;">{{ facility.icon }}</i>
              </div>
              <h4 style="font-size: 1.6rem; font-weight: 700; color: var(--text-primary); margin: 0;">{{ facility.name }}</h4>
            </div>
            <p style="color: var(--text-secondary); font-size: 1rem; line-height: 1.7; margin-bottom: 20px;">
              {{ facility.description|truncatewords:25 }}
            </p>
            {% if facility.get_features_list %}
            <ul style="list-style: none; padding: 0; margin: 0;">
              {% for feature in facility.get_features_list|slice:":3" %}
              <li style="color: var(--text-secondary); margin-bottom: 8px; display: flex; align-items: center;">
                <i class="material-icons" style="font-size: 1rem; color: var(--accent-gold); margin-right: 10px;">check_circle</i>
                {{ feature }}
              </li>
              {% endfor %}
            </ul>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}

<!-- All Facilities Grid -->
{% if facilities %}
<section class="section" style="padding: 80px 0; background: var(--light-bg);">
  <div class="container">
    <div style="text-align: center; margin-bottom: 60px;">
      <h2 style="font-size: 3rem; font-weight: 800; color: var(--text-primary); margin-bottom: 20px; text-transform: uppercase;">All Facilities</h2>
      <p style="color: var(--text-secondary); font-size: 1.2rem;">Complete range of amenities for your fitness journey</p>
    </div>

    <div class="row" style="display:flex; flex-wrap:wrap; gap:30px; justify-content:center;">
      {% for facility in facilities %}
      <div class="col s12 m6 l4" style="display:flex;">
        <article class="facility-card hoverable" style="width:100%; border-radius:12px; overflow:hidden; background:#fff; box-shadow: var(--shadow-md); display:flex; flex-direction:column;">
          <div style="position:relative; height: 240px;">
            {% if facility.image_url %}
              <img src="{{ facility.image_url }}" alt="{{ facility.name }}" style="width:100%; height:100%; object-fit:cover; display:block;">
            {% else %}
              <div style="position:absolute; inset:0; background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-dark) 100%); display:flex; align-items:center; justify-content:center;">
                <i class="material-icons" style="font-size: 3rem; color:#fff; opacity:.9;">{{ facility.icon }}</i>
              </div>
            {% endif %}
            <div style="position:absolute; left:0; right:0; bottom:0; padding:14px 16px; background: linear-gradient(180deg, rgba(0,0,0,0) 35%, rgba(0,0,0,0.8) 100%);">
              <h3 style="margin:0; color:#fff; font-weight:900; font-size:1.2rem; letter-spacing:.2px;">{{ facility.name }}</h3>
            </div>
          </div>
          <div style="padding:18px 16px;">
            <p style="color: var(--text-secondary); font-size: 0.98rem; line-height: 1.75; margin: 0;">
              {{ facility.description|default:""|truncatewords:50 }}
            </p>
            {% if facility.get_features_list %}
              <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:14px;">
                {% for feat in facility.get_features_list|slice:":4" %}
                  <span style="background:#f1f5f9; color:#475569; border:1px solid #e2e8f0; border-radius:999px; padding:6px 10px; font-size:.8rem;">{{ feat }}</span>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </article>
      </div>
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}

<!-- CTA Section -->
{% if facilities_page %}
<section style="padding: 0; margin: 80px 0;">
  <div class="container">
    <div style="background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-dark) 100%); border-radius: 20px; padding: 80px 40px; text-align: center; box-shadow: var(--shadow-lg);">
      <h2 style="font-size: 3rem; font-weight: 900; color: white; margin-bottom: 20px; text-transform: uppercase;">
        {{ facilities_page.cta_title|default:"Ready to Experience It?" }}
      </h2>
      <p style="color: rgba(255, 255, 255, 0.95); font-size: 1.3rem; max-width: 600px; margin: 0 auto 40px auto;">
        {{ facilities_page.cta_description|default:"Visit us for a free tour" }}
      </p>
      <a href="{{ facilities_page.cta_button_url|default:'/contact/' }}"
         class="btn btn-large"
         style="background: white; color: var(--primary-green); padding: 20px 50px; font-size: 1.2rem; font-weight: 700; border-radius: 50px; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 8px 25px rgba(0,0,0,0.2);">
        <i class="material-icons left">event</i>{{ facilities_page.cta_button_text|default:"Book a Tour" }}
      </a>
    </div>
  </div>
</section>
{% endif %}

{% endblock %}
